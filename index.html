<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sira Coranique ‚Äî V17 Final</title>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* -----------------------------------------------------------
       1. CSS (DESIGN & LAYOUT) - TON DESIGN INTACT
       ----------------------------------------------------------- */
    @import url('https://cdn.jsdelivr.net/npm/kfgqpc-uthmanic-script-hafs-regular@1.0.0/index.min.css');
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&family=Fredoka:wght@400;600&display=swap');

    :root {
      --primary: #6C5CE7; --bg-body: #F0F3F8; --card-bg: #ffffff;
      --th-mekka: #a29bfe; --th-trial: #ff7675; --th-hope: #fdcb6e; --th-medina: #00cec9; --th-win: #55efc4;
      --card-shadow: 0 6px 0 rgba(0,0,0,0.05);
      --bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      --quiz-bg: #2c0b56; --story-bg: #2d3436; --correct: #2ecc71; --wrong: #ff4757;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg-body); font-family: 'Nunito', sans-serif; padding-bottom: 80px; min-height: 100vh; color: #2d3436; }
    .app-container { width: 100%; max-width: 650px; margin: 0 auto; padding: 15px; }
    .d-none { display: none !important; }

    /* HEADER */
    .header-box {
      background: linear-gradient(135deg, #6C5CE7, #a29bfe); border-radius: 30px; padding: 25px 20px; color: white;
      box-shadow: 0 10px 25px rgba(108, 92, 231, 0.3); margin-bottom: 30px; text-align: center; position: relative; overflow: hidden;
    }
    .header-title { font-family: 'Fredoka', sans-serif; font-size: 1.6rem; margin: 0; position:relative; z-index:2; text-transform: uppercase; line-height: 1.3; }
    .header-sub { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; position:relative; z-index:2; font-weight: bold; }

    /* TIMELINE */
    .timeline-container { position: relative; padding-left: 20px; }
    .timeline-line {
      position: absolute; left: 29px; top: 20px; bottom: 0; width: 4px;
      background-image: linear-gradient(to bottom, #dfe6e9 50%, transparent 50%); background-size: 4px 20px; z-index: 0;
    }
    .timeline-section { margin-bottom: 40px; position: relative; z-index: 1; }
    .section-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .section-number {
      width: 40px; height: 40px; background: white; color: var(--primary); border: 3px solid var(--primary);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-family: 'Fredoka'; font-size: 1.1rem; font-weight: 700; box-shadow: 0 4px 0 rgba(0,0,0,0.1); flex-shrink: 0;
    }
    .section-title { font-family: 'Fredoka'; font-size: 1.1rem; margin: 0; }
    .section-desc { font-size: 0.8rem; color: #636e72; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

    /* HUB CARDS */
    .hub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; margin-left: 15px; }
    .hub-card {
      background: white; border-radius: 20px; padding: 15px; text-align: center; cursor: pointer; position: relative;
      transition: all 0.2s var(--bounce); display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 120px; border: 2px solid transparent; box-shadow: var(--card-shadow);
    }
    .hub-card:active { transform: scale(0.96); }
    .hub-card.locked { opacity: 0.7; background: #f1f2f6; border-bottom: 4px solid #dfe6e9; filter: grayscale(0.9); cursor: not-allowed; }
    
    .th-mekka { border-bottom: 5px solid var(--th-mekka); } .th-mekka .hub-icon { color: var(--th-mekka); }
    .th-trial { border-bottom: 5px solid var(--th-trial); } .th-trial .hub-icon { color: var(--th-trial); }
    .th-hope { border-bottom: 5px solid var(--th-hope); } .th-hope .hub-icon { color: #f39c12; }
    .th-medina { border-bottom: 5px solid var(--th-medina); } .th-medina .hub-icon { color: var(--th-medina); }
    .th-win { border-bottom: 5px solid var(--th-win); } .th-win .hub-icon { color: var(--th-win); }

    .hub-icon { font-size: 2rem; margin-bottom: 8px; display: block; }
    .hub-title-txt { font-family: 'Fredoka'; font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; line-height: 1.2; }
    .hub-sub-txt { font-size: 0.7rem; font-weight: 700; color: #b2bec3; }
    .lock-icon { position: absolute; top: 10px; right: 10px; font-size: 0.9rem; color: #b2bec3; }

    /* MODULE & COMMON */
    #view-module { display: none; }
    .home-btn { 
      position: absolute; left: 20px; top: 50%; transform: translateY(-50%); 
      background: rgba(255,255,255,0.25); border: none; color: white; width: 40px; height: 40px; 
      border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; z-index: 10;
    }
    
    .verse-card { background: var(--card-bg); border-radius: 24px; padding: 20px; border-bottom: 5px solid #dfe6e9; margin-bottom: 15px; }
    .verse-card.active { border-color: var(--primary); transform: scale(1.01); box-shadow: 0 0 25px rgba(108, 92, 231, 0.4); z-index: 10; }
    .verse-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .play-btn { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .play-btn.playing { background: #ff7675; animation: pulse 1.5s infinite; }
    
    .ar-text { font-family: 'KFGQPC Uthmanic Script HAFS Regular'; text-align: right; direction: rtl; font-size: 30px; margin: 10px 0; line-height: 1.6; }
    .tr-text { color: #e17055; font-weight: 800; font-size: 15px; margin-bottom: 5px; display:block; } 
    .fr-text { font-style: italic; font-size: 15px; color: #636e72; display:block; }
    
    .toolbar { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; flex-wrap: wrap; }
    .tool-btn { background: white; border: 2px solid #dfe6e9; border-radius: 12px; padding: 8px 14px; font-weight: 800; color: #636e72; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    
    .font-toolbar { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 25px; background: rgba(255,255,255,0.5); padding: 8px; border-radius: 16px; }
    .mini-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #dfe6e9; background: white; font-weight: 900; color: #2d3436; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    
    .fabs-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 200; }
    .fab-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 1.6rem; cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
    .fab-story { background: #0984e3; border: 3px solid white; } .fab-quiz { background: #fdcb6e; border: 3px solid white; }
    .badge { background:#f1f2f6; color:#636e72; font-weight:900; padding:6px 12px; border-radius:12px; font-size:0.75rem; text-transform: uppercase; }

    /* MODALS */
    .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 300; display: none; flex-direction: column; overflow-y: auto; }
    .fullscreen-modal.open { display: flex; animation: fadeIn 0.3s; }
    .story-bg { background: var(--story-bg); color: white; align-items: center; padding: 20px; }
    .story-card { background: white; color: #2d3436; width: 100%; max-width: 500px; border-radius: 24px; padding: 25px; margin-top: 15px; text-align: center; }
    .story-img { font-size: 3.5rem; display: block; margin-bottom: 10px; }
    .story-title { font-family: 'Fredoka'; font-size: 1.4rem; color: var(--primary); margin-bottom: 10px; }
    .story-text { font-size: 1rem; line-height: 1.6; color: #444; margin-bottom: 15px; text-align: left; }
    
    .source-btn { background: transparent; border: 1px solid #ddd; padding: 5px 10px; border-radius: 20px; color: #7f8c8d; font-size: 0.7rem; font-weight: 700; cursor: pointer; margin-top: 10px; display:inline-flex; align-items:center; gap:5px; }
    .source-content { display: none; background: #f1f2f6; padding: 10px; border-radius: 8px; margin-top: 10px; text-align: left; font-size: 0.8rem; border-left: 3px solid var(--primary); color:#333; }
    .story-nav-btn { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: 800; font-size: 1rem; cursor: pointer; margin-top: 20px; }
    
    /* QUIZ */
    .quiz-bg { background: var(--quiz-bg); color: white; padding: 15px; align-items: center; }
    .quiz-nav { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 10px; }
    .game-area { width: 100%; max-width: 500px; display: none; flex-direction: column; align-items: center; padding-bottom: 40px; }
    .question-box { margin-bottom: 25px; min-height: 120px; width: 100%; text-align: center; display: flex; flex-direction: column; justify-content: center; }
    .q-ar { font-family: 'KFGQPC Uthmanic Script HAFS Regular'; font-size: 3rem; direction: rtl; }
    .q-tr-game { font-family: 'Nunito'; font-size: 1rem; background: rgba(0,0,0,0.25); padding: 8px 14px; border-radius: 12px; display: inline-block; margin-top: 10px; }
    
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
    .game-btn { background: #5f27cd; color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 800; cursor: pointer; box-shadow: 0 5px 0 #3c1585; min-height: 70px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .game-btn.correct { background: var(--correct) !important; box-shadow: 0 5px 0 #219150; }
    .game-btn.wrong { background: var(--wrong) !important; box-shadow: 0 5px 0 #c0392b; opacity: 0.7; }
    
    .puzzle-dropzone { width: 100%; min-height: 100px; border: 3px dashed rgba(255,255,255,0.3); border-radius: 16px; display: flex; flex-wrap: wrap; direction: rtl !important; justify-content: flex-start; gap: 8px; padding: 10px; background: rgba(0,0,0,0.15); margin-bottom: 20px; }
    .puzzle-source { width: 100%; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; direction: rtl !important; }
    .puzzle-piece { background: white; color: #2d3436; padding: 8px 12px; border-radius: 8px; font-family: 'KFGQPC Uthmanic Script HAFS Regular'; font-size: 1.3rem; cursor: pointer; }
    .correction-box { margin-top: 20px; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 15px; color: #ffcccc; font-weight: 800; display: none; }
    
    #level-complete { position: absolute; top:0; left:0; width:100%; height:100%; background:var(--quiz-bg); z-index:500; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
    .grid-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; width: 100%; max-width: 500px; margin-top: 20px; }
    .menu-card { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 20px 10px; text-align: center; cursor: pointer; border: 3px solid transparent; }
    .menu-icon { font-size: 2.5rem; display: block; margin-bottom: 5px; }
    .progress-track { width: 100%; max-width: 500px; height: 10px; background: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden; margin-bottom: 20px; display: none; }
    .progress-fill { height: 100%; width: 0%; background: #00cec9; transition: width 0.5s ease; }
    .close-btn { background: none; border: none; color: white; font-size: 1.4rem; cursor: pointer; opacity: 0.8; }

    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>

<body>

<div id="view-hub">
  <div class="header-box">
    <h1 class="header-title">LA MISSION DU<br>PROPHETE MUHAMMAD Ô∑∫</h1>
    <div class="header-sub">Sira & Coran</div>
  </div>

  <div class="timeline-container">
    <div class="timeline-line"></div>

    <div class="timeline-section">
      <div class="section-header"><div class="section-number">1</div><div class="section-info"><h3 class="section-title">Les Origines</h3><div class="section-desc">Mecque - 570</div></div></div>
      <div class="hub-grid">
        <div class="hub-card th-mekka" onclick="loadModule('al-fil')"><span class="hub-icon">üêò</span><div class="hub-title-txt">Al-Fil</div><div class="hub-sub-txt">L'√âl√©phant</div></div>
        <div class="hub-card th-mekka locked"><span class="lock-icon">üîí</span><span class="hub-icon">üïå</span><div class="hub-title-txt">Quraysh</div><div class="hub-sub-txt">La Tribu</div></div>
      </div>
    </div>

    <div class="timeline-section">
      <div class="section-header"><div class="section-number">2</div><div class="section-info"><h3 class="section-title">La R√©v√©lation</h3><div class="section-desc">Grotte de Hira</div></div></div>
      <div class="hub-grid">
        <div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">‚õ∞Ô∏è</span><div class="hub-title-txt">Al-'Alaq</div><div class="hub-sub-txt">Lis !</div></div>
        <div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">üõå</span><div class="hub-title-txt">Al-Muddathir</div><div class="hub-sub-txt">L√®ve-toi</div></div>
      </div>
    </div>

    <div class="timeline-section">
      <div class="section-header"><div class="section-number">3</div><div class="section-info"><h3 class="section-title">La Promesse</h3><div class="section-desc">Confiance en Allah</div></div></div>
      <div class="hub-grid">
        <div class="hub-card th-hope" onclick="loadModule('ar-rum')">
          <span class="hub-icon">‚öîÔ∏è</span><div class="hub-title-txt">Ar-Rum</div><div class="hub-sub-txt">Les Romains</div>
        </div>
      </div>
    </div>

    <div class="timeline-section">
        <div class="section-header"><div class="section-number">4</div><div class="section-info"><h3 class="section-title">L'Appel Public</h3><div class="section-desc">Mont Safa</div></div></div>
        <div class="hub-grid"><div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">üì£</span><div class="hub-title-txt">Al-Hijr</div><div class="hub-sub-txt">Proclame !</div></div></div>
    </div>
    
    <div class="timeline-section">
        <div class="section-header"><div class="section-number">5</div><div class="section-info"><h3 class="section-title">Les Premiers</h3><div class="section-desc">Convertis</div></div></div>
        <div class="hub-grid"><div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">ü§ù</span><div class="hub-title-txt">Az-Zumar</div><div class="hub-sub-txt">Groupes</div></div></div>
    </div>

    <div class="timeline-section">
        <div class="section-header"><div class="section-number">6</div><div class="section-info"><h3 class="section-title">L'√âpreuve</h3><div class="section-desc">Pers√©cutions</div></div></div>
        <div class="hub-grid"><div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">üï∏Ô∏è</span><div class="hub-title-txt">Al-Ankabut</div><div class="hub-sub-txt">L'Araign√©e</div></div></div>
    </div>

    <div class="timeline-section">
        <div class="section-header"><div class="section-number">7</div><div class="section-info"><h3 class="section-title">L'Abyssinie</h3><div class="section-desc">L'Exil</div></div></div>
        <div class="hub-grid"><div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">üö¢</span><div class="hub-title-txt">Maryam</div><div class="hub-sub-txt">Marie</div></div></div>
    </div>

    <div class="timeline-section">
        <div class="section-header"><div class="section-number">8</div><div class="section-info"><h3 class="section-title">Hamza & Umar</h3><div class="section-desc">Force</div></div></div>
        <div class="hub-grid"><div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">ü¶Å</span><div class="hub-title-txt">Al-Hadid</div><div class="hub-sub-txt">Le Fer</div></div></div>
    </div>

    <div class="timeline-section">
        <div class="section-header"><div class="section-number">9</div><div class="section-info"><h3 class="section-title">Le Boycott</h3><div class="section-desc">Famine</div></div></div>
        <div class="hub-grid"><div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">üçÇ</span><div class="hub-title-txt">Al-Mu'minun</div><div class="hub-sub-txt">Patience</div></div></div>
    </div>

    <div class="timeline-section">
        <div class="section-header"><div class="section-number">10</div><div class="section-info"><h3 class="section-title">Ann√©e de Tristesse</h3><div class="section-desc">Pauvret√© & Solitude</div></div></div>
        <div class="hub-grid">
            <div class="hub-card th-hope" onclick="loadModule('ad-duha')"><span class="hub-icon">‚òÄÔ∏è</span><div class="hub-title-txt">Ad-Duha</div><div class="hub-sub-txt">Le Jour</div></div>
            <div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">‚ù§Ô∏è</span><div class="hub-title-txt">Ash-Sharh</div><div class="hub-sub-txt">L'Ouverture</div></div>
        </div>
    </div>

    <div class="timeline-section">
        <div class="section-header"><div class="section-number">11</div><div class="section-info"><h3 class="section-title">Isra & Mi'raj</h3><div class="section-desc">Voyage Nocturne</div></div></div>
        <div class="hub-grid"><div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">üåå</span><div class="hub-title-txt">Al-Isra</div><div class="hub-sub-txt">Le Voyage</div></div></div>
    </div>

    <div class="timeline-section">
        <div class="section-header"><div class="section-number">12</div><div class="section-info"><h3 class="section-title">L'H√©gire</h3><div class="section-desc">Vers M√©dine</div></div></div>
        <div class="hub-grid"><div class="hub-card locked"><span class="lock-icon">üîí</span><span class="hub-icon">üê™</span><div class="hub-title-txt">Al-Anfal</div><div class="hub-sub-txt">Le Butin</div></div></div>
    </div>

  </div>
</div>

<div id="view-module">
  <div class="header-box">
    <button class="home-btn" onclick="goHome()">üè†</button>
    <h1 class="header-title" id="mod-title">...</h1>
  </div>
  
  <div class="toolbar">
    <div class="tool-btn">
      <span style="font-size:1.1rem">üéôÔ∏è</span>
      <select id="reciter-opt" onchange="changeReciter(this.value)" class="reciter-select" style="min-width:100px;">
        <option value="Minshawy_Teacher_128kbps">Minshawi (Enfant)</option>
        <option value="Husary_Muallim_128kbps">Al-Hussary</option>
        <option value="Alafasy_128kbps">Mishary Alafasy</option>
      </select>
    </div>
    <button class="tool-btn" onclick="toggleLayer('tr-text', this)">üëÅÔ∏è Phon√©tique</button>
    <button class="tool-btn" onclick="toggleLayer('fr-text', this)">üìñ Fran√ßais</button>
    <button class="tool-btn" onclick="openStoryHub()" style="border-color:#0984e3; color:#0984e3;">üìú Raconte-moi</button>
  </div>

  <div class="font-toolbar">
    <div class="font-group"><span class="font-label">AR</span><button class="mini-btn" onclick="adjustSize('ar', -2)">-</button><button class="mini-btn" onclick="adjustSize('ar', 2)">+</button></div>
    <div class="font-group" style="margin-left:15px;"><span class="font-label">FR/TR</span><button class="mini-btn" onclick="adjustSize('tr', -1); adjustSize('fr', -1)">-</button><button class="mini-btn" onclick="adjustSize('tr', 1); adjustSize('fr', 1)">+</button></div>
  </div>

  <div id="verses-container"></div>

  <div class="fabs-container">
    <button class="fab-btn fab-quiz" onclick="openGameHub()">üß†</button>
    <button class="fab-btn fab-story" onclick="openStoryHub()">üìú</button>
  </div>
</div>

<div class="fullscreen-modal story-bg" id="story-modal">
  <div class="quiz-nav" style="color:white; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
    <button class="close-btn" onclick="closeStory()">‚úï Fermer</button>
    <div style="font-weight:900;">CONTEXTE SIRA</div>
  </div>
  <div id="story-age-select" class="grid-menu" style="max-width:400px;">
    <div class="menu-card" onclick="selectStoryAge('eveil')" style="background:white; color:#333;"><span class="menu-icon">üê£</span><div class="menu-title">Groupe √âveil</div></div>
    <div class="menu-card" onclick="selectStoryAge('chercheur')" style="background:white; color:#333;"><span class="menu-icon">ü¶Å</span><div class="menu-title">Groupe Chercheur</div></div>
  </div>
  <div id="story-container" style="width:100%; display:none; flex-direction:column; align-items:center;"></div>
</div>

<div class="fullscreen-modal quiz-bg" id="game-modal">
  <div class="quiz-nav"><button class="close-btn" onclick="closeGameHub()">‚úï Quitter</button><div style="font-weight:900;">JEUX</div></div>
  <div class="progress-track" id="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
  <div id="age-select-screen" class="grid-menu" style="max-width:400px;">
    <div class="menu-card" onclick="selectAge('age6')" style="background:white; color:#333;"><span class="menu-icon">üê£</span><div class="menu-title">Groupe √âveil</div></div>
    <div class="menu-card" onclick="selectAge('age8')" style="background:white; color:#333;"><span class="menu-icon">ü¶Å</span><div class="menu-title">Groupe Chercheur</div></div>
  </div>
  <div id="level-select-screen" class="grid-menu" style="display:none; max-width:400px;">
    <div class="menu-card" onclick="selectLevel('vocab')" style="background:white; color:#333;"><span class="menu-icon">üìö</span><div class="menu-title">Vocabulaire</div></div>
    <div class="menu-card" onclick="selectLevel('puzzle')" style="background:white; color:#333;"><span class="menu-icon">üß©</span><div class="menu-title">Puzzle</div></div>
    <div class="menu-card" onclick="selectLevel('missing')" style="background:white; color:#333;"><span class="menu-icon">üßê</span><div class="menu-title">Expert</div></div>
  </div>
  <div id="game-area" class="game-area">
    <div id="question-box" class="question-box"></div><div id="options-grid" class="options-grid" style="display:none;"></div>
    <div id="puzzle-area" class="puzzle-area" style="display:none;"><div id="puzzle-dropzone" class="puzzle-dropzone"></div><div id="puzzle-source" class="puzzle-source"></div></div>
    <div id="correction-box" class="correction-box"></div>
  </div>
  <div id="level-complete"><span class="neon-text">ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá</span><h2 style="margin:0; color:white;">MA SHA ALLAH !</h2><button id="next-level-btn" class="game-btn" style="background:white; color:var(--quiz-bg); margin-top:20px; width:100%; z-index:999;" onclick="resetGame()">Menu</button></div>
</div>

<script>
  // ====================== DATA ======================
  const ModuleContent = {
    "ar-rum": {
      title: "Ar-Rum (Les Romains)", surahId: 30,
      verses: [
        { id:1, ar:"ÿßŸÑŸìŸÖŸì", tr:"Alif - L√¢m - M√Æm", fr:"Alif, L√¢m, M√Æm." },
        { id:2, ar:"ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê Ÿ±ŸÑÿ±ŸèŸëŸàŸÖŸè", tr:"Ghoulibati r-Roum", fr:"Les Romains ont √©t√© vaincus," },
        { id:3, ar:"ŸÅŸêŸäŸì ÿ£ŸéÿØ€°ŸÜŸéŸâ Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿê ŸàŸéŸáŸèŸÖ ŸÖŸêŸëŸÜ€¢ ÿ®Ÿéÿπ€°ÿØŸê ÿ∫ŸéŸÑŸéÿ®ŸêŸáŸêŸÖ€° ÿ≥ŸéŸäŸéÿ∫€°ŸÑŸêÿ®ŸèŸàŸÜŸé", tr:"Fƒ´ adna l-ar·∏çi wa hum min ba‚Äòdi ghalabihim sayaghlib≈´n", fr:"dans le pays voisin, et apr√®s leur d√©faite ils seront vainqueurs," },
        { id:4, ar:"ŸÅŸêŸä ÿ®Ÿêÿ∂€°ÿπŸê ÿ≥ŸêŸÜŸêŸäŸÜŸé€ó ŸÑŸêŸÑŸéŸëŸáŸê Ÿ±ŸÑ€°ÿ£ŸéŸÖ€°ÿ±Ÿè ŸÖŸêŸÜ ŸÇŸéÿ®€°ŸÑŸè ŸàŸéŸÖŸêŸÜ€¢ ÿ®Ÿéÿπ€°ÿØŸè€ö ŸàŸéŸäŸéŸà€°ŸÖŸéÿ¶Ÿêÿ∞Ÿñ ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè Ÿ±ŸÑ€°ŸÖŸèÿ§€°ŸÖŸêŸÜŸèŸàŸÜŸé", tr:"Fƒ´ bi·∏ç‚Äòi sinƒ´n. LillƒÅhi l-amru min qablu wa min ba‚Äòdu wa-yawma-idhin yafra·∏•u al-mu‚Äômin≈´n", fr:"dans quelques ann√©es. √Ä Allah appartient le commandement, avant comme apr√®s, et ce jour-l√† les Croyants se r√©jouiront." }
      ],
      story: {
        eveil: [
          { img:"‚öîÔ∏è", title:"La Guerre", text:"Il y a longtemps, deux grands pays se faisaient la guerre : les Romains et les Perses. Les Perses √©taient tr√®s forts et ont gagn√© une grande bataille.", sourceDetail:"Contexte Historique 614 ap. J.C" },
          { img:"üò¢", title:"La Tristesse", text:"√Ä la Mecque, les croyants √©taient tristes. Les m√©chants se moquaient d'eux : 'Vos amis les Romains ont perdu, vous allez perdre aussi !'", sourceDetail:"Tafsir Ibn Kathir" },
          { img:"‚ú®", title:"La Promesse", text:"Mais Allah a envoy√© le Proph√®te Ô∑∫ pour dire : 'Ne soyez pas tristes ! Dans quelques ann√©es, les Romains vont gagner !' C'√©tait une promesse d'Allah.", sourceDetail:"Coran 30:2-4" },
          { img:"üèÜ", title:"La Victoire", text:"Et c'est arriv√© ! Quelques ann√©es plus tard, les Romains ont gagn√©. Allah dit toujours la v√©rit√© et aide les croyants.", sourceDetail:"Histoire : Co√Øncide avec la bataille de Badr." }
        ],
        chercheur: [
          { img:"‚öîÔ∏è", title:"Le Contexte G√©opolitique", text:"Les Perses (Sassanides) ont √©cras√© les Romains (Byzantins) et ont m√™me pris J√©rusalem. C'√©tait un choc mondial !", sourceDetail:"Ibn Kathir (Tafsir Ar-Rum) : Les Perses dominaient tout le Proche-Orient vers 614-615." },
          { img:"üòß", title:"Le Choc √† la Mecque", text:"Les polyth√©istes de la Mecque disaient aux Compagnons : 'Les adorateurs du feu (Perses) ont battu les Gens du Livre (Romains). Nous aussi, nous vous battrons !'", sourceDetail:"Jami` at-Tirmidhi 3193 : Les m√©cr√©ants aimaient voir les Perses gagner." },
          { img:"ü§ù", title:"Le Pari (Al-Mouqabala)", text:"Abu Bakr (ra) √©tait si s√ªr de la r√©v√©lation qu'il a fait un pari avec Ubayy bin Khalaf : 100 chameaux que les Romains gagneront !", sourceDetail:"At-Tirmidhi 3193 (Sahih) : C'√©tait avant l'interdiction des jeux de hasard." },
          { img:"‚è≥", title:"La D√©finition de 'Bid'", text:"Le Coran utilise le mot 'Bid'i Sinin'. En arabe pur, cela signifie entre 3 et 9 ans. La proph√©tie √©tait donc tr√®s pr√©cise.", sourceDetail:"Linguistique Arabe : Bid' (ÿ®ÿ∂ÿπ) d√©signe un nombre de 3 √† 9." },
          { img:"üö´", title:"L'Aum√¥ne (Sadaqah)", text:"Abu Bakr a gagn√© le pari ! Mais le jeu de hasard venait d'√™tre interdit. Le Proph√®te Ô∑∫ lui a dit : 'C'est un gain illicite (Suh't), donne-le aux pauvres.'", sourceDetail:"At-Tirmidhi : L'Islam interdit de profiter des gains de paris." }
        ]
      },
      games: {
        age6: {
          vocab: [
            {q:"Ÿ±ŸÑÿ±ŸèŸëŸàŸÖŸè",tr:"Ar-Roum",a:"Les Romains",opts:[{t:"Les Romains",i:"üõ°Ô∏è"},{t:"La Terre",i:"üåç"}]},
            {q:"ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê",tr:"Ghoulibati",a:"Ont √©t√© vaincus",opts:[{t:"Ont √©t√© vaincus",i:"üè≥Ô∏è"},{t:"Ont gagn√©",i:"üèÜ"}]},
            {q:"Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿê",tr:"Al-Ard",a:"La Terre",opts:[{t:"La Terre",i:"üåç"},{t:"Le Ciel",i:"‚òÅÔ∏è"}]},
            {q:"ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè",tr:"Yafrahou",a:"Se r√©jouir",opts:[{t:"Se r√©jouir",i:"üòä"},{t:"Pleurer",i:"üò¢"}]},
            {q:"Ÿ±ŸÑ€°ŸÖŸèÿ§€°ŸÖŸêŸÜŸèŸàŸÜŸé",tr:"Al-Mouminoun",a:"Les Croyants",opts:[{t:"Les Croyants",i:"ü§≤"},{t:"Les Autos",i:"üöó"}]},
            {q:"ÿ≥ŸêŸÜŸêŸäŸÜŸé",tr:"Sinin",a:"Ann√©es",opts:[{t:"Ann√©es",i:"üìÖ"},{t:"Jours",i:"‚òÄÔ∏è"}]}
          ],
          puzzle: [
            {full:["ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê","Ÿ±ŸÑÿ±ŸèŸëŸàŸÖŸè"],tr:"Ghoulibati r-Roum"},
            {full:["ŸÅŸêŸäŸì","ÿ£ŸéÿØ€°ŸÜŸéŸâ","Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿê"],tr:"Fi adna l-ardi"},
            {full:["ŸÑŸêŸÑŸéŸëŸáŸê","Ÿ±ŸÑ€°ÿ£ŸéŸÖ€°ÿ±Ÿè"],tr:"Lillahi l-amr"},
            {full:["ŸàŸéŸäŸéŸà€°ŸÖŸéÿ¶Ÿêÿ∞Ÿñ","ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè"],tr:"Wa yawma-idhin yafrahu"},
            {full:["ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè","Ÿ±ŸÑ€°ŸÖŸèÿ§€°ŸÖŸêŸÜŸèŸàŸÜŸé"],tr:"Yafrahu l-mouminoun"},
            {full:["ŸÖŸêŸÜ","ŸÇŸéÿ®€°ŸÑŸè"],tr:"Min qablu"}
          ],
          missing: [
            {q:"ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê .......",tr:"Ghoulibati ...",a:"Ÿ±ŸÑÿ±ŸèŸëŸàŸÖŸè",opts:[{t:"Ÿ±ŸÑÿ±ŸèŸëŸàŸÖŸè",i:"üõ°Ô∏è"},{t:"Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿè",i:"üåç"}]},
            {q:"....... Ÿ±ŸÑ€°ÿ£ŸéŸÖ€°ÿ±Ÿè",tr:"... l-amr",a:"ŸÑŸêŸÑŸéŸëŸáŸê",opts:[{t:"ŸÑŸêŸÑŸéŸëŸáŸê",i:"‚òùÔ∏è"},{t:"ŸÑŸêŸÑŸÜŸéŸëÿßÿ≥Ÿê",i:"üë•"}]},
            {q:"ŸàŸéŸäŸéŸà€°ŸÖŸéÿ¶Ÿêÿ∞Ÿñ .......",tr:"Wa yawma-idhin ...",a:"ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè",opts:[{t:"ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè",i:"üòä"},{t:"ŸäŸéÿ®€°ŸÉŸêŸä",i:"üò¢"}]},
            {q:"....... Ÿ±ŸÑ€°ŸÖŸèÿ§€°ŸÖŸêŸÜŸèŸàŸÜŸé",tr:"... l-mouminoun",a:"ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè",opts:[{t:"ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè",i:"üòä"},{t:"ŸäŸéŸÜŸéÿßŸÖŸè",i:"üò¥"}]},
            {q:"ŸÅŸêŸä ÿ®Ÿêÿ∂€°ÿπŸê .......",tr:"Fi bid'i ...",a:"ÿ≥ŸêŸÜŸêŸäŸÜŸé",opts:[{t:"ÿ≥ŸêŸÜŸêŸäŸÜŸé",i:"üìÖ"},{t:"ÿ£ŸéŸäŸéŸëÿßŸÖŸç",i:"‚òÄÔ∏è"}]},
            {q:"ŸÅŸêŸäŸì ÿ£ŸéÿØ€°ŸÜŸéŸâ .......",tr:"Fi adna ...",a:"Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿê",opts:[{t:"Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿê",i:"üåç"},{t:"Ÿ±ŸÑÿ≥ŸéŸëŸÖŸéÿ¢ÿ°Ÿê",i:"‚òÅÔ∏è"}]}
          ]
        },
        age8: {
          vocab: [
            {q:"ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê",tr:"Ghoulibati",a:"Ont √©t√© vaincus",opts:["Ont gagn√©","Ont √©t√© vaincus","Ont voyag√©"]},
            {q:"ÿ®Ÿêÿ∂€°ÿπŸê",tr:"Bi·∏ç‚Äòi",a:"3 √† 9",opts:["Beaucoup","Un seul","3 √† 9"]},
            {q:"ÿ£ŸéÿØ€°ŸÜŸéŸâ",tr:"Adna",a:"Voisin / Plus bas",opts:["Plus haut","Voisin / Plus bas","Lointain"]},
            {q:"ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè",tr:"Yafrahu",a:"Se r√©jouir",opts:["Se r√©jouir","Pleurer","Dormir"]},
            {q:"Ÿ±ŸÑ€°ÿ£ŸéŸÖ€°ÿ±Ÿè",tr:"Al-Amr",a:"Le Commandement",opts:["Le Conseil","Le Commandement","L'Argent"]},
            {q:"ÿ≥ŸéŸäŸéÿ∫€°ŸÑŸêÿ®ŸèŸàŸÜŸé",tr:"Sayaghliboun",a:"Ils vaincront",opts:["Ils vaincront","Ils perdront","Ils partiront"]}
          ],
          puzzle: [
            {full:["ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê","Ÿ±ŸÑÿ±ŸèŸëŸàŸÖŸè"],tr:"Ghoulibati r-Roum"},
            {full:["ŸÅŸêŸäŸì","ÿ£ŸéÿØ€°ŸÜŸéŸâ","Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿê"],tr:"Fi adna l-ardi"},
            {full:["ŸàŸéŸáŸèŸÖ","ŸÖŸêŸëŸÜ€¢","ÿ®Ÿéÿπ€°ÿØŸê","ÿ∫ŸéŸÑŸéÿ®ŸêŸáŸêŸÖ€°","ÿ≥ŸéŸäŸéÿ∫€°ŸÑŸêÿ®ŸèŸàŸÜŸé"],tr:"Wa hum min ba'di ghalabihim sayaghlib≈´n"},
            {full:["ŸÑŸêŸÑŸéŸëŸáŸê","Ÿ±ŸÑ€°ÿ£ŸéŸÖ€°ÿ±Ÿè","ŸÖŸêŸÜ","ŸÇŸéÿ®€°ŸÑŸè","ŸàŸéŸÖŸêŸÜ€¢","ÿ®Ÿéÿπ€°ÿØŸè€ö"],tr:"LillƒÅhi l-amru min qablu wa min ba'du"},
            {full:["ŸàŸéŸäŸéŸà€°ŸÖŸéÿ¶Ÿêÿ∞Ÿñ","ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè","Ÿ±ŸÑ€°ŸÖŸèÿ§€°ŸÖŸêŸÜŸèŸàŸÜŸé"],tr:"Wa yawma-idhin yafrahu l-mouminoun"},
            {full:["ŸÅŸêŸä","ÿ®Ÿêÿ∂€°ÿπŸê","ÿ≥ŸêŸÜŸêŸäŸÜŸé"],tr:"Fi bid'i sinin"}
          ],
          missing: [
            {q:"ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê .......",tr:"Ghoulibati ...",a:"Ÿ±ŸÑÿ±ŸèŸëŸàŸÖŸè",opts:["Ÿ±ŸÑÿ±ŸèŸëŸàŸÖŸè","Ÿ±ŸÑ€°ŸÅŸèÿ±€°ÿ≥Ÿè"]},
            {q:"....... Ÿ±ŸÑ€°ÿ£ŸéŸÖ€°ÿ±Ÿè ŸÖŸêŸÜ ŸÇŸéÿ®€°ŸÑŸè",tr:"... al-amru...",a:"ŸÑŸêŸÑŸéŸëŸáŸê",opts:["ŸÑŸêŸÑŸéŸëŸáŸê","ŸÑŸêŸÑŸíŸÖŸéŸÑŸêŸÉŸê"]},
            {q:"ŸàŸéŸäŸéŸà€°ŸÖŸéÿ¶Ÿêÿ∞Ÿñ ....... Ÿ±ŸÑ€°ŸÖŸèÿ§€°ŸÖŸêŸÜŸèŸàŸÜŸé",tr:"Wa yawma-idhin ... al-mouminoun",a:"ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè",opts:["ŸäŸéŸÅ€°ÿ±Ÿéÿ≠Ÿè","ŸäŸéÿ≠Ÿíÿ≤ŸéŸÜŸè"]},
            {q:"ŸàŸéŸáŸèŸÖ ŸÖŸêŸëŸÜ€¢ ....... ÿ∫ŸéŸÑŸéÿ®ŸêŸáŸêŸÖ€°",tr:"Wa hum min ... ghalabihim",a:"ÿ®Ÿéÿπ€°ÿØŸê",opts:["ÿ®Ÿéÿπ€°ÿØŸê","ŸÇŸéÿ®ŸíŸÑŸê"]},
            {q:"ŸÅŸêŸäŸì ÿ£ŸéÿØ€°ŸÜŸéŸâ .......",tr:"Fi adna ...",a:"Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿê",opts:["Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿê","Ÿ±ŸÑÿ≥ŸéŸëŸÖŸéÿ¢ÿ°Ÿê"]},
            {q:"ŸÅŸêŸä ÿ®Ÿêÿ∂€°ÿπŸê .......",tr:"Fi bid'i ...",a:"ÿ≥ŸêŸÜŸêŸäŸÜŸé",opts:["ÿ≥ŸêŸÜŸêŸäŸÜŸé","ÿ£ŸéŸäŸéŸëÿßŸÖŸç"]}
          ]
        }
      }
    },
    // MODULES DE DEMO
    "al-fil": {
      title: "Al-Fil (L'√âl√©phant)", surahId: 105,
      verses: [
        { id:1, ar:"ÿ£ŸéŸÑŸéŸÖŸí ÿ™Ÿéÿ±Ÿé ŸÉŸéŸäŸíŸÅŸé ŸÅŸéÿπŸéŸÑŸé ÿ±Ÿéÿ®ŸèŸëŸÉŸé ÿ®Ÿêÿ£ŸéÿµŸíÿ≠ŸéŸ∞ÿ®Ÿê Ÿ±ŸÑŸíŸÅŸêŸäŸÑŸê", tr:"Alam tara kayfa...", fr:"N'as-tu pas vu comment ton Seigneur a agi envers les gens de l'√âl√©phant ?" }
      ],
      story: { eveil:[], chercheur:[] }, games: { age6:{}, age8:{} }
    },
    "ad-duha": {
      title: "Ad-Duha", surahId: 93,
      verses: [{id:1,ar:"ŸàŸéŸ±ŸÑÿ∂ŸèŸëÿ≠ŸéŸâŸ∞",tr:"Wad-Duha",fr:"Par le jour montant"}],
      story: {eveil:[],chercheur:[]}, games: {age6:{},age8:{}}
    }
  };

  // ====================== ENGINE ======================
  
  // CORRECTION FONTS : Ajout de la variable qui manquait
  let fontSizes = { ar: 30, tr: 15, fr: 15 };

  let currentData = null;
  function loadModule(id) {
    if(!ModuleContent[id]) return alert("Module en construction !");
    currentData = ModuleContent[id];
    document.getElementById('view-hub').style.display='none';
    document.getElementById('view-module').style.display='block';
    window.scrollTo(0,0);
    document.getElementById('mod-title').innerText = currentData.title;
    const cont = document.getElementById('verses-container'); cont.innerHTML='';
    currentData.verses.forEach(v => {
      const c = document.createElement('div'); c.className='verse-card'; c.id=`card-${currentData.surahId}-${v.id}`;
      c.innerHTML=`<div class="verse-header"><span class="badge">Verset ${v.id}</span><div class="audio-controls"><button class="play-btn" id="btn-${currentData.surahId}-${v.id}" onclick="playAyah(${currentData.surahId},${v.id})">‚ñ∂</button></div></div><div class="ar-text">${v.ar}</div><div class="tr-text">${v.tr}</div><div class="fr-text">${v.fr}</div>`;
      cont.appendChild(c);
    });
    // R√©appliquer les polices actuelles
    adjustSize('ar', 0); adjustSize('tr', 0);
  }
  
  function goHome() { stopAudio(); document.getElementById('view-module').style.display='none'; document.getElementById('view-hub').style.display='block'; }

  // --- AUDIO ---
  let reciter="Minshawy_Teacher_128kbps", currentAudio=null, currentBtnId=null;
  function changeReciter(v){reciter=v;stopAudio();}
  function toggleLayer(c,b){document.querySelectorAll('.'+c).forEach(e=>e.classList.toggle('d-none')); b.style.opacity=(b.style.opacity==="0.5")?"1":"0.5";}
  function stopAudio(){if(currentAudio){currentAudio.pause();currentAudio=null;} document.querySelectorAll('.play-btn').forEach(b=>{b.classList.remove('playing');b.innerText="‚ñ∂"}); document.querySelectorAll('.verse-card').forEach(c=>c.classList.remove('active'));}
  function playAyah(s,a){
    const btnId=`btn-${s}-${a}`;
    if(currentAudio && currentBtnId===btnId){ if(currentAudio.paused){currentAudio.play();document.getElementById(btnId).innerText="‚è∏";document.getElementById(btnId).classList.add('playing');}else{currentAudio.pause();document.getElementById(btnId).innerText="‚ñ∂";document.getElementById(btnId).classList.remove('playing');} return; }
    stopAudio(); currentBtnId=btnId;
    const btn=document.getElementById(btnId); if(btn){btn.innerText="‚è∏";btn.classList.add('playing');}
    const card=document.getElementById(`card-${s}-${a}`); if(card)card.classList.add('active');
    currentAudio=new Audio(`https://everyayah.com/data/${reciter}/${String(s).padStart(3,'0')}${String(a).padStart(3,'0')}.mp3`);
    currentAudio.onended=()=>stopAudio(); currentAudio.play().catch(e=>stopAudio());
  }

  // --- STORY ---
  let currentStoryType='eveil', storyIdx=0;
  function openStoryHub(){if(currentAudio)stopAudio();document.getElementById('story-modal').classList.add('open');document.getElementById('story-age-select').style.display='grid';document.getElementById('story-container').style.display='none';}
  function closeStory(){document.getElementById('story-modal').classList.remove('open');}
  function selectStoryAge(t){currentStoryType=t;document.getElementById('story-age-select').style.display='none';document.getElementById('story-container').style.display='flex';storyIdx=0;renderStory();}
  function renderStory(){
    const list = currentData.story[currentStoryType];
    if(!list || list.length===0){document.getElementById('story-container').innerHTML="<p style='color:white;'>Bient√¥t...</p>";return;}
    const data = list[storyIdx];
    const btnText = (storyIdx < list.length-1) ? "Suivant ‚û°" : "Terminer ‚úÖ";
    const btnAction = (storyIdx < list.length-1) ? "nextStory()" : "closeStory()";
    document.getElementById('story-container').innerHTML = `
      <div class="story-card">
        <span class="story-img">${data.img}</span><div class="story-title">${data.title}</div><div class="story-text">${data.text}</div>
        <button class="source-btn" onclick="toggleSource(this)">üîç Source</button><div class="source-content">${data.sourceDetail}</div>
      </div>
      <button class="story-nav-btn" onclick="${btnAction}">${btnText}</button>
    `;
  }
  function nextStory(){storyIdx++;renderStory();}
  function toggleSource(btn){const c=btn.nextElementSibling; if(c.style.display==="block"){c.style.display="none";btn.innerHTML="üîç Source";}else{c.style.display="block";btn.innerHTML="‚ùå Fermer";}}

  // --- GAMES ENGINE ---
  let currentAge, currentLevel, currentQuestions=[], questionIdx=0;
  const levelOrder=['vocab','puzzle','missing'];
  const screens={age:document.getElementById('age-select-screen'),level:document.getElementById('level-select-screen'),game:document.getElementById('game-area'),win:document.getElementById('level-complete')};
  
  function openGameHub(){if(currentAudio)stopAudio();document.getElementById('game-modal').classList.add('open');resetGame();}
  function closeGameHub(){document.getElementById('game-modal').classList.remove('open');}
  function resetGame(){screens.age.style.display='grid';screens.level.style.display='none';screens.game.style.display='none';screens.win.style.display='none';document.getElementById('progress-track').style.display='none';}
  function selectAge(a){currentAge=a;screens.age.style.display='none';screens.level.style.display='grid';}
  function selectLevel(l){
    currentLevel=l; screens.level.style.display='none'; screens.game.style.display='flex'; screens.win.style.display='none';
    document.getElementById('progress-track').style.display='block';
    const gData = currentData.games[currentAge] && currentData.games[currentAge][currentLevel];
    if(!gData || gData.length===0) { alert("Jeux √† venir !"); resetGame(); return; }
    currentQuestions=[...gData].sort(()=>Math.random()-0.5); questionIdx=0; loadQuestion();
  }
  function loadQuestion(){
    if(questionIdx>=currentQuestions.length){finishLevel();return;}
    document.getElementById('progress-fill').style.width=((questionIdx/currentQuestions.length)*100)+'%';
    document.getElementById('correction-box').style.display='none'; isLocked=false;
    const data=currentQuestions[questionIdx];
    const qBox=document.getElementById('question-box'), optGrid=document.getElementById('options-grid'), puzArea=document.getElementById('puzzle-area');
    qBox.innerHTML=''; optGrid.innerHTML=''; optGrid.style.display='none'; puzArea.style.display='none';

    if(currentLevel==='puzzle'){
      puzArea.style.display='block'; qBox.innerHTML=`<div class="q-tr-game" style="color:white; margin-bottom:10px;">${data.tr}</div>`;
      const drop=document.getElementById('puzzle-dropzone'), src=document.getElementById('puzzle-source'); drop.innerHTML=''; src.innerHTML='';
      let userIndices=[], pieces=data.full.map((w,i)=>({w,i}));
      pieces.sort(()=>Math.random()-0.5).forEach(pObj=>{
        const p=document.createElement('div'); p.className='puzzle-piece'; p.innerText=pObj.w; p.dataset.idx=pObj.i;
        p.onclick=function(){
          if(this.parentNode===src){drop.appendChild(this); userIndices.push(parseInt(this.dataset.idx));}
          else{src.appendChild(this); userIndices=userIndices.filter(i=>i!==parseInt(this.dataset.idx));}
          checkPuzzle(userIndices, data.full.length, drop);
        };
        src.appendChild(p);
      });
    } else {
      optGrid.style.display='grid'; qBox.innerHTML=`<div class="q-ar">${data.q}</div><div class="q-tr-game">${data.tr}</div>`;
      [...data.opts].sort(()=>Math.random()-0.5).forEach(opt=>{
        const btn=document.createElement('button'); btn.className='game-btn';
        let valText=(typeof opt==='object')?opt.t:opt;
        btn.innerHTML=(typeof opt==='object')?`<span class="game-btn-icon">${opt.i}</span><span>${opt.t}</span>`:`<span>${opt}</span>`;
        btn.onclick=()=>checkOption(btn, valText, data.a); btn.dataset.val=valText; optGrid.appendChild(btn);
      });
    }
  }
  function checkPuzzle(uIdx, total, drop){
    if(uIdx.length===total){
      if(uIdx.every((v,i)=>v===i)){drop.style.borderColor="#2ecc71"; fireConfetti(); setTimeout(()=>{questionIdx++;loadQuestion();drop.style.borderColor="rgba(255,255,255,0.3)";},1000);}
      else{drop.style.borderColor="#ff4757"; drop.animate([{transform:'translateX(0)'},{transform:'translateX(-10px)'},{transform:'translateX(10px)'},{transform:'translateX(0)'}],{duration:300});}
    }
  }
  function checkOption(btn, sel, corr){
    if(isLocked)return; isLocked=true;
    if(sel===corr){btn.classList.add('correct'); fireConfetti(); setTimeout(()=>{questionIdx++;loadQuestion();},1000);}
    else{btn.classList.add('wrong'); navigator.vibrate?.(300); document.querySelectorAll('.game-btn').forEach(b=>{if(b.dataset.val===corr)b.classList.add('reveal')}); document.getElementById('correction-box').style.display='block'; document.getElementById('correction-box').innerText=`Correction : ${corr}`; setTimeout(()=>{questionIdx++;loadQuestion();},2500);}
  }
  function finishLevel(){
    screens.game.style.display='none'; screens.win.style.display='flex'; fireMassiveConfetti();
    const btn=document.getElementById('next-level-btn'), currentIdx=levelOrder.indexOf(currentLevel);
    if(currentIdx<levelOrder.length-1){ btn.innerText="Jeu Suivant ‚û°"; btn.onclick=()=>selectLevel(levelOrder[currentIdx+1]); }
    else{ btn.innerText="Menu Principal üè†"; btn.onclick=()=>resetGame(); }
  }
  
  // FONCTION TAILLE POLICE CORRIGEE
  function adjustSize(t,d){ 
    fontSizes[t]+=d; 
    if(fontSizes[t]<10)fontSizes[t]=10; 
    if(fontSizes[t]>70)fontSizes[t]=70; 
    
    if(t==='ar')document.querySelectorAll('.ar-text').forEach(e=>e.style.fontSize=fontSizes.ar+'px');
    if(t==='tr')document.querySelectorAll('.tr-text').forEach(e=>e.style.fontSize=fontSizes.tr+'px');
    if(t==='fr')document.querySelectorAll('.fr-text').forEach(e=>e.style.fontSize=fontSizes.fr+'px'); 
  }

  function fireConfetti(){confetti({particleCount:50,spread:60,origin:{y:0.7}});}
  function fireMassiveConfetti(){const end=Date.now()+3000; (function frame(){confetti({particleCount:5,angle:60,spread:55,origin:{x:0},colors:['#00ff88','#fdcb6e']});confetti({particleCount:5,angle:120,spread:55,origin:{x:1},colors:['#00ff88','#fdcb6e']});if(Date.now()<end)requestAnimationFrame(frame);}());}
</script>
</body>
</html>
