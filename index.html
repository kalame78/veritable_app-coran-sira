<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sira Coranique ‚Äî V11 Sira Integration</title>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* ... (CSS RESTE IDENTIQUE AUX VERSIONS PR√âC√âDENTES - Optimis√© V9) ... */
    @import url('https://cdn.jsdelivr.net/npm/kfgqpc-uthmanic-script-hafs-regular@1.0.0/index.min.css');
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Fredoka:wght@400;600&display=swap');

    :root { --primary: #6C5CE7; --bg-color: #dfe6e9; --card-bg: #ffffff; --quiz-bg: #2c0b56; --story-bg: #2d3436; --lvl-1: #00b894; --lvl-2: #0984e3; --lvl-3: #d63031; --correct: #2ecc71; --wrong: #ff4757; --neon-glow: #00ff88; --bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg-color) radial-gradient(#b2bec3 15%, transparent 16%) 0 0 / 24px 24px; font-family: 'Nunito', sans-serif; padding-bottom: 120px; min-height: 100vh; }
    .app-container { width: 100%; max-width: 800px; margin: 0 auto; padding: 15px; }
    @media (min-width: 801px) { .app-container { margin-top: 30px; background: rgba(255,255,255,0.4); border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); padding: 40px; } }

    /* UI COMPONENTS */
    .header-box { background: linear-gradient(135deg, var(--primary), #4834d4); border-radius: 24px; padding: 20px; color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 15px; text-align: center; }
    .header-title { font-family: 'Fredoka', sans-serif; font-size: 1.8rem; margin: 0; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
    .font-toolbar { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 25px; background: rgba(255,255,255,0.5); padding: 8px; border-radius: 16px; }
    .tool-btn { background: white; border: 2px solid #dfe6e9; border-radius: 14px; padding: 10px 16px; font-weight: 800; color: #636e72; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.2s; }
    .tool-btn:hover, .tool-btn.active { border-color: var(--primary); color: var(--primary); background: #fdfdff; transform: translateY(-2px); }
    .reciter-select { border: none; background: transparent; font-family: 'Nunito'; font-weight: 800; color: #2d3436; outline: none; cursor: pointer; font-size: 0.9rem; }
    .mini-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #dfe6e9; background: white; font-weight: 900; color: #2d3436; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .mini-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

    /* CARDS */
    .verse-card { background: var(--card-bg); border-radius: 24px; padding: 20px; border-bottom: 5px solid #dfe6e9; margin-bottom: 15px; transition: transform 0.3s var(--bounce); }
    .verse-card.active { border-color: var(--primary); transform: scale(1.01); box-shadow: 0 0 25px rgba(108, 92, 231, 0.4); z-index: 10; }
    .verse-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .badge { background:#f1f2f6; color:#636e72; font-weight:900; padding:6px 12px; border-radius:12px; font-size:0.75rem; text-transform: uppercase; }
    .play-btn { background: var(--primary); color: white; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: 0.2s; }
    .play-btn.playing { background: #ff7675; animation: pulse 1.5s infinite; }
    .ar-text { font-family: 'KFGQPC Uthmanic Script HAFS Regular', serif; text-align: right; direction: rtl; margin: 10px 0 15px 0; line-height: 1.7; font-size: 32px; transition: font-size 0.2s ease; }
    .tr-text, .fr-text { font-size: 16px; display: block; margin-bottom: 4px; transition: font-size 0.2s ease; }
    .tr-text { color: #e17055; font-weight: 800; } .fr-text { color: #636e72; font-style: italic; }
    .d-none { display: none !important; }

    /* MODALS */
    .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 300; display: none; flex-direction: column; overflow-y: auto; }
    .fullscreen-modal.open { display: flex; animation: fadeIn 0.3s; }
    
    /* STORY SPECIFIC */
    .story-bg { background: var(--story-bg); color: white; align-items: center; padding: 20px; }
    .story-card { background: white; color: #2d3436; width: 100%; max-width: 500px; border-radius: 24px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; margin-top: 10px; animation: slideUp 0.4s var(--bounce); }
    .story-img { font-size: 3.5rem; margin-bottom: 10px; display: block; }
    .story-title { font-family: 'Fredoka'; font-size: 1.4rem; color: var(--primary); margin-bottom: 10px; }
    .story-text { font-size: 1rem; line-height: 1.6; color: #444; margin-bottom: 15px; text-align: left; }
    
    .source-btn { background: transparent; border: 1px solid #ddd; padding: 5px 10px; border-radius: 20px; color: #7f8c8d; font-size: 0.7rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; margin-top: 10px; }
    .source-content { display: none; background: #f1f2f6; padding: 12px; border-radius: 8px; margin-top: 10px; width: 100%; text-align: left; font-size: 0.8rem; color: #2d3436; border-left: 3px solid var(--primary); line-height: 1.4; }
    .story-nav-btn { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: 800; font-size: 1rem; cursor: pointer; margin-top: 20px; width: 100%; max-width: 300px; }

    /* GAME & RECORDER (Legacy) */
    .quiz-bg { background: var(--quiz-bg); color: white; padding: 20px; align-items: center; }
    .recorder-bg { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); justify-content: flex-end; }
    .recorder-sheet { background: white; width: 100%; border-radius: 30px 30px 0 0; padding: 30px; text-align: center; max-width: 600px; margin: 0 auto; animation: slideUp 0.3s; }
    .mic-big-btn { width: 80px; height: 80px; border-radius: 50%; background: #f1f2f6; border: 4px solid var(--wrong); color: var(--wrong); font-size: 2.2rem; margin: 20px auto; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .mic-big-btn.recording { background: var(--wrong); color: white; animation: pulse 1s infinite; }
    
    /* MENUS */
    .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 500px; margin-top: 20px; }
    .menu-card { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; text-align: center; cursor: pointer; border: 3px solid transparent; }
    .menu-card:hover { background: rgba(255,255,255,0.2); }
    .menu-icon { font-size: 2.5rem; display: block; margin-bottom: 5px; }
    .menu-title { font-family: 'Fredoka'; font-weight: 600; }
    .menu-sub { font-size: 0.75rem; opacity: 0.7; }

    /* GAMEPLAY */
    .game-area { width: 100%; max-width: 500px; display: none; flex-direction: column; align-items: center; }
    .question-box { margin-bottom: 20px; min-height: 100px; width: 100%; text-align: center; }
    .q-ar { font-family: 'KFGQPC Uthmanic Script HAFS Regular'; font-size: 2.8rem; line-height: 1.4; direction: rtl; }
    .q-tr-game { background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 8px; font-size: 0.9rem; color: #a29bfe; font-weight: 700; display: inline-block; }
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
    .game-btn { background: #5f27cd; color: white; border: none; padding: 15px; border-radius: 15px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 0 #3c1585; position: relative; min-height: 70px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .game-btn:active { transform: translateY(4px); box-shadow: none; }
    .game-btn.correct { background: var(--correct) !important; box-shadow: 0 4px 0 #219150; }
    .game-btn.wrong { background: var(--wrong) !important; opacity: 0.6; }
    .puzzle-dropzone { width: 100%; min-height: 100px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 15px; display: flex; flex-wrap: wrap; direction: rtl !important; justify-content: flex-start; gap: 8px; padding: 10px; background: rgba(0,0,0,0.1); margin-bottom: 20px; }
    .puzzle-source { width: 100%; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; direction: rtl !important; }
    .puzzle-piece { background: white; color: #333; padding: 8px 12px; border-radius: 8px; font-family: 'KFGQPC Uthmanic Script HAFS Regular'; font-size: 1.3rem; cursor: pointer; box-shadow: 0 3px 0 #ccc; }
    
    .fabs-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 200; }
    .fab-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 1.6rem; cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
    .fab-story { background: #0984e3; border: 3px solid white; }
    .fab-quiz { background: #fdcb6e; color: #d35400; border: 3px solid white; }

    #level-complete { position: absolute; top:0; left:0; width:100%; height:100%; background:var(--quiz-bg); z-index:500; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
    
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    @keyframes neonZoom { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1.2); opacity: 1; } }
  </style>
</head>

<body>

<div class="app-container">
  <div class="header-box"><h1 class="header-title">Surah Ar-Rum</h1></div>

  <div class="toolbar">
    <div class="tool-btn">
      <span style="font-size:1.1rem">üéôÔ∏è</span>
      <select id="reciter-opt" onchange="changeReciter(this.value)" class="reciter-select">
        <option value="Minshawy_Teacher_128kbps">Minshawi (Enfant)</option>
        <option value="Alafasy_128kbps">Mishary Alafasy</option>
        <option value="Husary_Muallim_128kbps">Al-Hussary</option>
      </select>
    </div>
    <button class="tool-btn" onclick="toggleLayer('tr-text', this)">üëÅÔ∏è Phon√©tique</button>
    <button class="tool-btn" onclick="toggleLayer('fr-text', this)">üìñ Fran√ßais</button>
    <button class="tool-btn" onclick="openStoryHub()" style="border-color:#0984e3; color:#0984e3;">üìú Raconte-moi</button>
  </div>

  <div class="font-toolbar">
    <div class="font-group"><span class="font-label">AR</span><button class="mini-btn" onclick="adjustSize('ar', -2)">-</button><button class="mini-btn" onclick="adjustSize('ar', 2)">+</button></div>
    <div class="font-group" style="margin-left:15px;"><span class="font-label">FR/TR</span><button class="mini-btn" onclick="adjustSize('tr', -1); adjustSize('fr', -1)">-</button><button class="mini-btn" onclick="adjustSize('tr', 1); adjustSize('fr', 1)">+</button></div>
  </div>

  <div class="verse-card" id="card-30-1">
    <div class="verse-header"><span class="badge">Verset 1</span><div class="audio-controls"><button class="play-btn" id="btn-30-1" onclick="playAyah(30,1)">‚ñ∂</button></div></div>
    <div class="ar-text">ÿßŸÑŸìŸÖŸì</div><div class="tr-text">Alif - L√¢m - M√Æm</div><div class="fr-text">Alif, L√¢m, M√Æm.</div>
  </div>
  <div class="verse-card" id="card-30-2">
    <div class="verse-header"><span class="badge">Verset 2</span><div class="audio-controls"><button class="play-btn" id="btn-30-2" onclick="playAyah(30,2)">‚ñ∂</button></div></div>
    <div class="ar-text">ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê Ÿ±ŸÑÿ±ŸëŸèŸàŸÖŸè</div><div class="tr-text">Ghoulibati r-Roum</div><div class="fr-text">Les Romains ont √©t√© vaincus,</div>
  </div>
  <div class="verse-card" id="card-30-3">
    <div class="verse-header"><span class="badge">Verset 3</span><div class="audio-controls"><button class="play-btn" id="btn-30-3" onclick="playAyah(30,3)">‚ñ∂</button></div></div>
    <div class="ar-text">ŸÅŸêŸäŸì ÿ£ŸéÿØ€°ŸÜŸéŸâ Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿê ŸàŸéŸáŸèŸÖ ŸÖŸëŸêŸÜ€¢ ÿ®Ÿéÿπ€°ÿØŸê ÿ∫ŸéŸÑŸéÿ®ŸêŸáŸêŸÖ€° ÿ≥ŸéŸäŸéÿ∫€°ŸÑŸêÿ®ŸèŸàŸÜŸé</div><div class="tr-text">Fƒ´ adna l-ar·∏çi...</div><div class="fr-text">dans le pays voisin... ils seront vainqueurs,</div>
  </div>
  <div class="verse-card" id="card-30-4">
    <div class="verse-header"><span class="badge">Verset 4</span><div class="audio-controls"><button class="play-btn" id="btn-30-4" onclick="playAyah(30,4)">‚ñ∂</button></div></div>
    <div class="ar-text">ŸÅŸêŸä ÿ®Ÿêÿ∂€°ÿπŸê ÿ≥ŸêŸÜŸêŸäŸÜŸé€ó...</div><div class="tr-text">Fƒ´ bi·∏ç‚Äòi sinƒ´n...</div><div class="fr-text">dans quelques ann√©es...</div>
  </div>
</div>

<div class="fabs-container">
  <button class="fab-btn fab-quiz" onclick="openGameHub()">üß†</button>
  <button class="fab-btn fab-story" onclick="openStoryHub()">üìú</button>
  <button class="fab-btn fab-mic" onclick="openRecorder()">üé§</button>
</div>

<div class="fullscreen-modal story-bg" id="story-modal">
  <div class="quiz-nav" style="color:white; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
    <button class="close-btn" onclick="closeStory()">‚úï Fermer</button>
    <div style="font-weight:900;">HISTOIRE & CONTEXTE</div>
  </div>
  
  <div id="story-age-select" class="grid-menu">
    <div class="menu-card" onclick="selectStoryAge('eveil')" style="border-color:var(--lvl-1);">
      <span class="menu-icon">üê£</span><div class="menu-title">Raconte-moi</div><div class="menu-sub">Version Simple</div>
    </div>
    <div class="menu-card" onclick="selectStoryAge('chercheur')" style="border-color:var(--lvl-3);">
      <span class="menu-icon">ü¶Å</span><div class="menu-title">Deep Research</div><div class="menu-sub">D√©tails & Preuves</div>
    </div>
  </div>

  <div id="story-container" style="width:100%; display:none; flex-direction:column; align-items:center;"></div>
</div>

<div class="fullscreen-modal quiz-bg" id="game-modal">
  <div class="quiz-nav">
    <button class="close-btn" onclick="closeGameHub()">‚úï Quitter</button>
    <div style="font-weight:900;">JEUX</div>
  </div>
  <div class="progress-track" id="progress-track"><div class="progress-fill" id="progress-fill"></div></div>

  <div id="age-select-screen" class="grid-menu">
    <div class="menu-card" onclick="selectAge('age6')" style="border-color:var(--lvl-1);"><span class="menu-icon">üê£</span><div class="menu-title">Groupe √âveil</div><div class="menu-sub">D√©butants</div></div>
    <div class="menu-card" onclick="selectAge('age8')" style="border-color:var(--lvl-3);"><span class="menu-icon">ü¶Å</span><div class="menu-title">Groupe Chercheur</div><div class="menu-sub">Avanc√©s</div></div>
  </div>
  <div id="level-select-screen" class="grid-menu" style="display:none;">
    <div class="menu-card" onclick="selectLevel('vocab')" style="border-color:var(--lvl-1);"><span class="menu-icon">üìö</span><div class="menu-title">Vocabulaire</div></div>
    <div class="menu-card" onclick="selectLevel('puzzle')" style="border-color:var(--lvl-2);"><span class="menu-icon">üß©</span><div class="menu-title">Puzzle</div></div>
    <div class="menu-card" onclick="selectLevel('missing')" style="border-color:var(--lvl-3);"><span class="menu-icon">üßê</span><div class="menu-title">Expert</div></div>
  </div>
  <div id="game-area" class="game-area">
    <div id="question-box" class="question-box"></div>
    <div id="options-grid" class="options-grid" style="display:none;"></div>
    <div id="puzzle-area" class="puzzle-area"><div style="margin-bottom:10px; font-size:0.85rem; color:#aaa; font-weight:700;">D√©but de la phrase ‚û°Ô∏è</div><div id="puzzle-dropzone" class="puzzle-dropzone"></div><div id="puzzle-source" class="puzzle-source"></div></div>
    <div id="correction-box" class="correction-box"></div>
  </div>
  <div id="level-complete">
    <span class="neon-text">ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá</span><h2 style="margin:0; color:white;">MA SHA ALLAH !</h2>
    <button id="next-level-btn" class="game-btn" style="background:white; color:var(--quiz-bg); margin-top:20px; width:100%; z-index:999;" onclick="resetGame()">Menu</button>
  </div>
</div>

<div class="fullscreen-modal recorder-bg" id="recorder-modal">
  <div class="recorder-sheet">
    <h2 style="font-family:'Fredoka'; color:#2d3436; margin-top:0;">Studio M√©morisation</h2>
    <p style="color:#636e72;">Enregistre ta r√©citation !</p>
    <div class="mic-big-btn" id="mic-trigger" onclick="toggleRecording()">üé§</div>
    <div id="mic-status" style="font-weight:800; color:#b2bec3;">Appuie pour enregistrer</div>
    <audio id="user-playback" controls style="width:100%; margin-top:15px; display:none;"></audio>
    <button onclick="closeRecorder()" style="background:none; border:none; color:#aaa; font-weight:700; margin-top:15px;">Fermer</button>
  </div>
</div>

<script>
  // -------------------------------------------------------------
  // SETTINGS & AUDIO
  // -------------------------------------------------------------
  let fontSizes = { ar: 32, tr: 16, fr: 16 }; 
  function adjustSize(type, delta) {
    fontSizes[type] += delta; if(fontSizes[type]<10)fontSizes[type]=10; if(fontSizes[type]>70)fontSizes[type]=70;
    if(type==='ar')document.querySelectorAll('.ar-text').forEach(e=>e.style.fontSize=fontSizes.ar+'px');
    if(type==='tr')document.querySelectorAll('.tr-text').forEach(e=>e.style.fontSize=fontSizes.tr+'px');
    if(type==='fr')document.querySelectorAll('.fr-text').forEach(e=>e.style.fontSize=fontSizes.fr+'px');
  }
  let reciter="Minshawy_Teacher_128kbps", currentAudio=null, currentBtnId=null;
  function changeReciter(v){reciter=v;stopAudio();}
  function toggleLayer(c,b){ document.querySelectorAll('.'+c).forEach(e=>e.classList.toggle('d-none')); b.style.opacity=(b.style.opacity==="0.5")?"1":"0.5"; }
  function stopAudio(){ if(currentAudio){currentAudio.pause(); currentAudio=null;} document.querySelectorAll('.play-btn').forEach(b=>{b.classList.remove('playing');b.innerText="‚ñ∂"}); document.querySelectorAll('.verse-card').forEach(c=>c.classList.remove('active')); currentBtnId=null; }
  function playAyah(s,a){
    const btnId=`btn-${s}-${a}`;
    if(currentAudio && currentBtnId===btnId){
      if(currentAudio.paused){ currentAudio.play(); document.getElementById(btnId).innerText="‚è∏"; document.getElementById(btnId).classList.add('playing'); }
      else { currentAudio.pause(); document.getElementById(btnId).innerText="‚ñ∂"; document.getElementById(btnId).classList.remove('playing'); }
      return;
    }
    stopAudio(); currentBtnId=btnId;
    const btn=document.getElementById(btnId); if(btn){btn.innerText="‚è∏";btn.classList.add('playing');}
    const card=document.getElementById(`card-${s}-${a}`); if(card)card.classList.add('active');
    const sStr=String(s).padStart(3,'0'), aStr=String(a).padStart(3,'0');
    currentAudio=new Audio(`https://everyayah.com/data/${reciter}/${sStr}${aStr}.mp3`);
    currentAudio.onended=()=>stopAudio(); currentAudio.play().catch(e=>stopAudio());
  }

  // -------------------------------------------------------------
  // DATA STORY (EVEIL vs CHERCHEUR)
  // -------------------------------------------------------------
  const storyDataContent = {
    // VERSION SIMPLE (√âVEIL)
    eveil: [
      {
        img: "‚öîÔ∏è",
        title: "La Guerre",
        text: "Il y a longtemps, deux grands pays se faisaient la guerre : les Romains et les Perses. Les Perses √©taient tr√®s forts et ont gagn√© !",
        sourceDetail: "<strong>Contexte :</strong> Guerre historique entre l'Empire Byzantin et l'Empire Sassanide (614 ap. J.C)."
      },
      {
        img: "üò¢",
        title: "La Tristesse",
        text: "√Ä la Mecque, les croyants √©taient tristes car ils aimaient bien les Romains. Les m√©chants se moquaient d'eux : <i>'Vos amis ont perdu, vous allez perdre aussi !'</i>",
        sourceDetail: "<strong>Tafsir Ibn Kathir :</strong> Les idol√¢tres de la Mecque se r√©jouissaient de la victoire des Perses (qui √©taient aussi idol√¢tres)."
      },
      {
        img: "‚ú®",
        title: "La Promesse d'Allah",
        text: "Mais Allah a envoy√© le Proph√®te Ô∑∫ pour dire : <b>'Ne soyez pas tristes ! Dans quelques ann√©es, les Romains vont gagner !'</b>",
        sourceDetail: "<strong>Coran 30:2-4 :</strong> La promesse divine d'une victoire romaine 'dans quelques ann√©es' (Bid'i Sinin)."
      },
      {
        img: "üèÜ",
        title: "La Victoire",
        text: "Et c'est arriv√© ! Quelques ann√©es plus tard, les Romains ont gagn√©. Allah dit toujours la v√©rit√©.",
        sourceDetail: "<strong>Histoire :</strong> La victoire romaine a eu lieu en m√™me temps que la victoire des musulmans √† Badr."
      }
    ],
    // VERSION DETAILL√âE (CHERCHEUR)
    chercheur: [
      {
        img: "‚öîÔ∏è",
        title: "Le Contexte G√©opolitique",
        text: "Les Perses (Sassanides) ont √©cras√© les Romains (Byzantins) et ont m√™me pris J√©rusalem. C'√©tait un choc mondial !",
        sourceDetail: "<strong>Ibn Kathir (Tafsir Ar-Rum) :</strong> Les Perses dominaient tout le Proche-Orient vers 614-615."
      },
      {
        img: "üòß",
        title: "Le Choc √† la Mecque",
        text: "Les polyth√©istes de la Mecque disaient aux Compagnons : <i>'Les adorateurs du feu (Perses) ont battu les Gens du Livre (Romains). Nous aussi, nous vous battrons !'</i>",
        sourceDetail: "<strong>Jami` at-Tirmidhi 3193 :</strong> Les m√©cr√©ants aimaient voir les Perses gagner car ils √©taient polyth√©istes comme eux."
      },
      {
        img: "ü§ù",
        title: "Le Pari (Al-Mouqabala)",
        text: "Abu Bakr (ra) √©tait si s√ªr de la r√©v√©lation qu'il a fait un pari avec Ubayy bin Khalaf : <b>100 chameaux que les Romains gagneront !</b>",
        sourceDetail: "<strong>At-Tirmidhi 3193 (Sahih) :</strong> C'√©tait avant l'interdiction des jeux de hasard. Le Proph√®te Ô∑∫ a conseill√© d'allonger le d√©lai √† 'moins de 10 ans' (Bid')."
      },
      {
        img: "‚è≥",
        title: "La D√©finition de 'Bid'",
        text: "Le Coran utilise le mot <b>'Bid'i Sinin'</b>. En arabe pur, cela signifie <b>entre 3 et 9 ans</b>. La proph√©tie √©tait donc tr√®s pr√©cise.",
        sourceDetail: "<strong>Linguistique Arabe :</strong> Bid' (ÿ®ÿ∂ÿπ) d√©signe un nombre de 3 √† 9. La victoire a eu lieu la 7√®me ann√©e."
      },
      {
        img: "üö´",
        title: "L'Aum√¥ne (Sadaqah)",
        text: "Abu Bakr a gagn√© le pari ! Mais le jeu de hasard venait d'√™tre interdit. Le Proph√®te Ô∑∫ lui a dit : <i>'C'est un gain illicite (Suh't), donne-le aux pauvres.'</i>",
        sourceDetail: "<strong>At-Tirmidhi :</strong> L'Islam interdit de profiter des gains de paris. L'argent a √©t√© purifi√© en aum√¥ne."
      }
    ]
  };

  let currentStoryType = 'eveil';
  let storyIdx = 0;

  function openStoryHub() {
    if(currentAudio) stopAudio();
    document.getElementById('story-modal').classList.add('open');
    document.getElementById('story-age-select').style.display = 'grid';
    document.getElementById('story-container').style.display = 'none';
  }
  function closeStory() { document.getElementById('story-modal').classList.remove('open'); }

  function selectStoryAge(type) {
    currentStoryType = type;
    document.getElementById('story-age-select').style.display = 'none';
    document.getElementById('story-container').style.display = 'flex';
    storyIdx = 0;
    renderStory();
  }

  function renderStory() {
    const container = document.getElementById('story-container');
    const data = storyDataContent[currentStoryType][storyIdx];
    const btnText = (storyIdx < storyDataContent[currentStoryType].length - 1) ? "Continuer ‚û°" : "Terminer ‚úÖ";
    const btnAction = (storyIdx < storyDataContent[currentStoryType].length - 1) ? "nextStory()" : "closeStory()";

    container.innerHTML = `
      <div class="story-card">
        <span class="story-img">${data.img}</span>
        <div class="story-title">${data.title}</div>
        <div class="story-text">${data.text}</div>
        <button class="source-btn" onclick="toggleSource(this)">üîç Source & D√©tails</button>
        <div class="source-content">${data.sourceDetail}</div>
      </div>
      <div style="margin-top:10px; color:#aaa; font-size:0.9rem;">Page ${storyIdx+1} / ${storyDataContent[currentStoryType].length}</div>
      <button class="story-nav-btn" onclick="${btnAction}">${btnText}</button>
    `;
  }

  function toggleSource(btn) {
    const content = btn.nextElementSibling;
    if (content.style.display === "block") { content.style.display = "none"; btn.innerHTML = "üîç Source & D√©tails"; }
    else { content.style.display = "block"; btn.innerHTML = "‚ùå Fermer"; }
  }
  function nextStory() { storyIdx++; renderStory(); }

  // -------------------------------------------------------------
  // GAME LOGIC
  // -------------------------------------------------------------
  const gameData = {
    age6: {
      vocab: [{q:"Ÿ±ŸÑÿ±ŸëŸèŸàŸÖŸè",tr:"Ar-Roum",a:"Les Romains",opts:[{t:"Les Romains",i:"üõ°Ô∏è"},{t:"La Terre",i:"üåç"},{t:"Le Livre",i:"üìñ"}]}, {q:"ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê",tr:"Ghoulibati",a:"Ont √©t√© vaincus",opts:[{t:"Ont √©t√© vaincus",i:"üè≥Ô∏è"},{t:"Ont gagn√©",i:"üèÜ"},{t:"Dorment",i:"üõå"}]}],
      puzzle: [{full:["ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê","Ÿ±ŸÑÿ±ŸëŸèŸàŸÖŸè"],tr:"Ghoulibati r-Roum"},{full:["ŸÅŸêŸäŸì","ÿ£ŸéÿØ€°ŸÜŸéŸâ","Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿê"],tr:"Fi adna l-ardi"}],
      missing: [{q:"ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê .......",tr:"Ghoulibati ...",a:"Ÿ±ŸÑÿ±ŸëŸèŸàŸÖŸè",opts:[{t:"Ÿ±ŸÑÿ±ŸëŸèŸàŸÖŸè",i:"üõ°Ô∏è"},{t:"Ÿ±ŸÑ€°ÿ£Ÿéÿ±€°ÿ∂Ÿè",i:"üåç"}]}, {q:"....... Ÿ±ŸÑ€°ÿ£ŸéŸÖ€°ÿ±Ÿè",tr:"... l-amr",a:"ŸÑŸêŸÑŸëŸéŸáŸê",opts:[{t:"ŸÑŸêŸÑŸëŸéŸáŸê",i:"‚òùÔ∏è"},{t:"ŸÑŸêŸÑŸÜŸëŸéÿßÿ≥Ÿê",i:"üë•"}]}]
    },
    age8: {
      vocab: [{q:"ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê",tr:"Ghoulibati",a:"Ont √©t√© vaincus",opts:["Ont gagn√©","Ont √©t√© vaincus","Ont voyag√©"]}, {q:"ÿ®Ÿêÿ∂€°ÿπŸê",tr:"Bi·∏ç‚Äòi",a:"3 √† 9",opts:["Beaucoup","Un seul","3 √† 9"]}],
      puzzle: [{full:["ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê","Ÿ±ŸÑÿ±ŸëŸèŸàŸÖŸè"],tr:"Ghoulibati r-Roum"},{full:["ŸÑŸêŸÑŸëŸéŸáŸê","Ÿ±ŸÑ€°ÿ£ŸéŸÖ€°ÿ±Ÿè","ŸÖŸêŸÜ","ŸÇŸéÿ®€°ŸÑŸè"],tr:"Lillahi l-amru min qablu"}],
      missing: [{q:"ÿ∫ŸèŸÑŸêÿ®Ÿéÿ™Ÿê .......",tr:"Ghoulibati ...",a:"Ÿ±ŸÑÿ±ŸëŸèŸàŸÖŸè",opts:["Ÿ±ŸÑÿ±ŸëŸèŸàŸÖŸè","Ÿ±ŸÑ€°ŸÅŸèÿ±€°ÿ≥Ÿè"]}, {q:"....... Ÿ±ŸÑ€°ÿ£ŸéŸÖ€°ÿ±Ÿè ŸÖŸêŸÜ ŸÇŸéÿ®€°ŸÑŸè",tr:"... al-amru...",a:"ŸÑŸêŸÑŸëŸéŸáŸê",opts:["ŸÑŸêŸÑŸëŸéŸáŸê","ŸÑŸêŸÑŸíŸÖŸéŸÑŸêŸÉŸê"]}]
    }
  };

  let currentAge, currentLevel, currentQuestions=[], questionIdx=0, isLocked=false;
  const levelOrder=['vocab','puzzle','missing'];
  const screens = { age:document.getElementById('age-select-screen'), level:document.getElementById('level-select-screen'), game:document.getElementById('game-area'), win:document.getElementById('level-complete') };

  function openGameHub(){if(currentAudio)stopAudio();document.getElementById('game-modal').classList.add('open');resetGame();}
  function closeGameHub(){document.getElementById('game-modal').classList.remove('open');}
  function resetGame(){screens.age.style.display='grid';screens.level.style.display='none';screens.game.style.display='none';screens.win.style.display='none';document.getElementById('progress-track').style.display='none';}
  function selectAge(a){currentAge=a;screens.age.style.display='none';screens.level.style.display='grid';}
  function selectLevel(l){currentLevel=l;screens.level.style.display='none';screens.game.style.display='flex';document.getElementById('progress-track').style.display='block';currentQuestions=[...gameData[currentAge][currentLevel]].sort(()=>Math.random()-0.5);questionIdx=0;loadQuestion();}

  function loadQuestion(){
    if(questionIdx>=currentQuestions.length){finishLevel();return;}
    document.getElementById('progress-fill').style.width=((questionIdx/currentQuestions.length)*100)+'%';
    document.getElementById('correction-box').style.display='none'; isLocked=false;
    const data=currentQuestions[questionIdx];
    const qBox=document.getElementById('question-box'), optGrid=document.getElementById('options-grid'), puzArea=document.getElementById('puzzle-area');
    qBox.innerHTML=''; optGrid.innerHTML=''; optGrid.style.display='none'; puzArea.style.display='none';

    if(currentLevel==='puzzle'){
      puzArea.style.display='block';
      qBox.innerHTML=`<div class="q-tr-game" style="color:white; margin-bottom:10px;">${data.tr}</div>`;
      const drop=document.getElementById('puzzle-dropzone'), src=document.getElementById('puzzle-source'); drop.innerHTML=''; src.innerHTML='';
      let userIndices=[], pieces=data.full.map((w,i)=>({w,i}));
      pieces.sort(()=>Math.random()-0.5).forEach(pObj=>{
        const p=document.createElement('div'); p.className='puzzle-piece'; p.innerText=pObj.w; p.dataset.idx=pObj.i;
        p.onclick=function(){
          if(this.parentNode===src){drop.appendChild(this); userIndices.push(parseInt(this.dataset.idx));}
          else{src.appendChild(this); userIndices=userIndices.filter(i=>i!==parseInt(this.dataset.idx));}
          checkPuzzle(userIndices, data.full.length, drop);
        };
        src.appendChild(p);
      });
    } else {
      optGrid.style.display='grid';
      qBox.innerHTML=`<div class="q-ar">${data.q}</div><div class="q-tr-game">${data.tr}</div>`;
      [...data.opts].sort(()=>Math.random()-0.5).forEach(opt=>{
        const btn=document.createElement('button'); btn.className='game-btn';
        let valText=(typeof opt==='object')?opt.t:opt;
        btn.innerHTML=(typeof opt==='object')?`<span class="game-btn-icon">${opt.i}</span><span>${opt.t}</span>`:`<span>${opt}</span>`;
        btn.onclick=()=>checkOption(btn, valText, data.a);
        btn.dataset.val=valText; optGrid.appendChild(btn);
      });
    }
  }

  function checkPuzzle(uIdx, total, drop){
    if(uIdx.length===total){
      if(uIdx.every((v,i)=>v===i)){drop.style.borderColor="#2ecc71"; fireConfetti(); setTimeout(()=>{questionIdx++;loadQuestion();drop.style.borderColor="rgba(255,255,255,0.3)";},1000);}
      else{drop.style.borderColor="#ff4757"; drop.animate([{transform:'translateX(0)'},{transform:'translateX(-10px)'},{transform:'translateX(10px)'},{transform:'translateX(0)'}],{duration:300});}
    }
  }
  function checkOption(btn, sel, corr){
    if(isLocked)return; isLocked=true;
    if(sel===corr){btn.classList.add('correct'); fireConfetti(); setTimeout(()=>{questionIdx++;loadQuestion();},1000);}
    else{btn.classList.add('wrong'); navigator.vibrate?.(300); 
      document.querySelectorAll('.game-btn').forEach(b=>{if(b.dataset.val===corr)b.classList.add('reveal')});
      document.getElementById('correction-box').style.display='block';
      document.getElementById('correction-box').innerText=`Correction : ${corr}`;
      setTimeout(()=>{questionIdx++;loadQuestion();},2500);
    }
  }
  function finishLevel(){
    screens.game.style.display='none'; screens.win.style.display='flex'; fireMassiveConfetti();
    const btn=document.getElementById('next-level-btn'), currentIdx=levelOrder.indexOf(currentLevel);
    if(currentIdx<levelOrder.length-1){ btn.innerText="Jeu Suivant ‚û°"; btn.onclick=()=>selectLevel(levelOrder[currentIdx+1]); }
    else{ btn.innerText="Menu Principal üè†"; btn.onclick=()=>resetGame(); }
  }

  // RECORDER
  const recModal=document.getElementById('recorder-modal');
  let mediaRecorder, audioChunks=[];
  function openRecorder(){if(currentAudio)stopAudio();recModal.classList.add('open');}
  function closeRecorder(){recModal.classList.remove('open');}
  function toggleRecording(){
    const btn=document.getElementById('mic-trigger'), stat=document.getElementById('mic-status');
    if(!btn.classList.contains('recording')){
      navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{
        mediaRecorder=new MediaRecorder(s); mediaRecorder.start(); audioChunks=[];
        mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
        mediaRecorder.onstop=()=>{
          const u=URL.createObjectURL(new Blob(audioChunks,{type:'audio/mp3'}));
          document.getElementById('user-playback').src=u; document.getElementById('user-playback').style.display='block';
          document.getElementById('save-rec-btn').style.display='block'; s.getTracks().forEach(t=>t.stop());
        };
        btn.classList.add('recording'); stat.innerText="Enregistrement..."; stat.style.color="#ff4757";
      }).catch(e=>alert("Micro bloqu√©"));
    } else { mediaRecorder.stop(); btn.classList.remove('recording'); stat.innerText="√âcoute-toi"; stat.style.color="#b2bec3"; }
  }
  function saveRecord(){fireConfetti(); setTimeout(()=>{closeRecorder();alert("Bravo !");},1500);}
  function fireConfetti(){confetti({particleCount:50,spread:60,origin:{y:0.7}});}
  function fireMassiveConfetti(){const end=Date.now()+3000; (function frame(){confetti({particleCount:5,angle:60,spread:55,origin:{x:0},colors:['#00ff88','#fdcb6e']});confetti({particleCount:5,angle:120,spread:55,origin:{x:1},colors:['#00ff88','#fdcb6e']});if(Date.now()<end)requestAnimationFrame(frame);}());}
</script>
</body>
</html>
